"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("../utils");
const PAGE_SUFFIX = '?page-loader=true';
function default_1(viteCompilerContext) {
    return {
        name: 'taro:vite-mini-page',
        enforce: 'pre',
        resolveId(source, _importer, options) {
            var _a;
            if ((viteCompilerContext === null || viteCompilerContext === void 0 ? void 0 : viteCompilerContext.isPage(source)) && options.isEntry) {
                if ((_a = viteCompilerContext.getPageById(source)) === null || _a === void 0 ? void 0 : _a.isNative)
                    return null;
                return (0, utils_1.appendVirtualModulePrefix)(source + PAGE_SUFFIX);
            }
            return null;
        },
        load(id) {
            if (viteCompilerContext && id.endsWith(PAGE_SUFFIX)) {
                const rawId = (0, utils_1.stripVirtualModulePrefix)(id).replace(PAGE_SUFFIX, '');
                const page = viteCompilerContext.getPageById(rawId);
                if (!page) {
                    viteCompilerContext.logger.warn(`编译页面 ${rawId} 失败!`);
                    process.exit(1);
                }
                const pageConfig = (0, utils_1.prettyPrintJson)(page.config);
                let instantiatePage = `var inst = Page(createPageConfig(component, '${page.name}', {root:{cn:[]}}, config || {}))`;
                if (typeof viteCompilerContext.loaderMeta.modifyInstantiate === 'function') {
                    instantiatePage = viteCompilerContext.loaderMeta.modifyInstantiate(instantiatePage, 'page');
                }
                return [
                    'import { createPageConfig } from "@tarojs/runtime"',
                    `import component from "${(0, utils_1.escapePath)(rawId)}"`,
                    `var config = ${pageConfig}`,
                    page.config.enableShareTimeline ? 'component.enableShareTimeline = true' : '',
                    page.config.enableShareAppMessage ? 'component.enableShareAppMessage = true' : '',
                    instantiatePage,
                ].join('\n');
            }
        }
    };
}
exports.default = default_1;
//# sourceMappingURL=page.js.map